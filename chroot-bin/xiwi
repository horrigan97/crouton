#!/bin/sh -e
# Copyright (c) 2014 The crouton Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Runs the specified X11 application in its own X server in Chromium OS.

. "`dirname "$0"`/../installer/functions"

if [ "$#" = 0 ]; then
    echo "Usage: $0 cmd params" 1>&2
    exit 2
elif [ "$1" = '/' ]; then
    shift 1
    "$@" &
    xiwicmd="`readlink -f "$0"`"
    exec ratpoison -f /dev/stdin <<WMRC
        escape C-S-M-Escape
        set border 0
        startup_message off
        addhook newwindow exec '$xiwicmd' // '$1'
        addhook switchwin exec '$xiwicmd' // '$1'
        addhook deletewindow exec sleep 1 \
            && ! ratpoison -c 'windows %%' | grep -q '%' \
            && ratpoison -c quit || true
WMRC
elif [ "$1" = '//' ]; then
    # Titlebar update. $2 has the original command name
    title="`ratpoison -c 'windows %s%t' | sed -n '/^\*/s/^.//p'`"
    title="`cat /etc/crouton/name`/$2: $title"
    xprop -root -f CROUTON_NAME 8s -set CROUTON_NAME "$title"
    ret="`{ echo -n 'C'; croutoncycle l; } | websocketcommand`"
    if [ "$ret" != 'COK' ]; then
        error 1 "${ret#?}"
    fi
else
    export XMETHOD=xiwi
    exec /usr/local/bin/xinit "`readlink -f "$0"`" / "$@"
fi
